suite: test networkpolicy
templates:
  - networkpolicy.yaml
tests:
  - it: should not create NetworkPolicy by default
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
    asserts:
      - hasDocuments:
          count: 0

  - it: should create NetworkPolicy when enabled
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      networkPolicy:
        enabled: true
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: NetworkPolicy
      - equal:
          path: metadata.name
          value: RELEASE-NAME-cloudflare-tunnel-gateway-controller

  - it: should have correct labels
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      networkPolicy:
        enabled: true
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: cloudflare-tunnel-gateway-controller
      - equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: RELEASE-NAME

  - it: should select correct pods
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      networkPolicy:
        enabled: true
    asserts:
      - equal:
          path: spec.podSelector.matchLabels["app.kubernetes.io/name"]
          value: cloudflare-tunnel-gateway-controller
      - equal:
          path: spec.podSelector.matchLabels["app.kubernetes.io/instance"]
          value: RELEASE-NAME

  - it: should have both Ingress and Egress policy types
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      networkPolicy:
        enabled: true
    asserts:
      - contains:
          path: spec.policyTypes
          content: Ingress
      - contains:
          path: spec.policyTypes
          content: Egress

  - it: should allow ingress on metrics port
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      networkPolicy:
        enabled: true
      service:
        metricsPort: 8080
    asserts:
      - contains:
          path: spec.ingress[0].ports
          content:
            protocol: TCP
            port: 8080

  - it: should allow ingress on health port
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      networkPolicy:
        enabled: true
      service:
        healthPort: 8081
    asserts:
      - contains:
          path: spec.ingress[0].ports
          content:
            protocol: TCP
            port: 8081

  - it: should allow ingress on custom ports
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      networkPolicy:
        enabled: true
      service:
        metricsPort: 9090
        healthPort: 9091
    asserts:
      - contains:
          path: spec.ingress[0].ports
          content:
            protocol: TCP
            port: 9090
      - contains:
          path: spec.ingress[0].ports
          content:
            protocol: TCP
            port: 9091

  - it: should allow DNS egress UDP
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      networkPolicy:
        enabled: true
    asserts:
      - contains:
          path: spec.egress[0].ports
          content:
            protocol: UDP
            port: 53

  - it: should allow DNS egress TCP
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      networkPolicy:
        enabled: true
    asserts:
      - contains:
          path: spec.egress[0].ports
          content:
            protocol: TCP
            port: 53

  - it: should allow Kubernetes API egress
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      networkPolicy:
        enabled: true
    asserts:
      - contains:
          path: spec.egress[1].ports
          content:
            protocol: TCP
            port: 443
      - contains:
          path: spec.egress[1].ports
          content:
            protocol: TCP
            port: 6443

  - it: should allow Cloudflare API egress to specific IP ranges only
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      networkPolicy:
        enabled: true
    asserts:
      # Verify specific Cloudflare IPv4 ranges are present
      - contains:
          path: spec.egress[2].to
          content:
            ipBlock:
              cidr: "173.245.48.0/20"
      - contains:
          path: spec.egress[2].to
          content:
            ipBlock:
              cidr: "104.16.0.0/13"
      - contains:
          path: spec.egress[2].to
          content:
            ipBlock:
              cidr: "172.64.0.0/13"
      # Verify specific Cloudflare IPv6 ranges are present
      - contains:
          path: spec.egress[2].to
          content:
            ipBlock:
              cidr: "2606:4700::/32"
      # Verify port 443
      - contains:
          path: spec.egress[2].ports
          content:
            protocol: TCP
            port: 443

  - it: should NOT allow 0.0.0.0/0 egress (security hardening)
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      networkPolicy:
        enabled: true
    asserts:
      - notContains:
          path: spec.egress[2].to
          content:
            ipBlock:
              cidr: "0.0.0.0/0"

  - it: should not have ingress from selector by default
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      networkPolicy:
        enabled: true
    asserts:
      - notExists:
          path: spec.ingress[0].from

  - it: should allow ingress from specific namespace
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      networkPolicy:
        enabled: true
        ingress:
          from:
            - namespaceSelector:
                matchLabels:
                  name: monitoring
    asserts:
      - contains:
          path: spec.ingress[0].from
          content:
            namespaceSelector:
              matchLabels:
                name: monitoring

  - it: should allow ingress from specific pods
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      networkPolicy:
        enabled: true
        ingress:
          from:
            - podSelector:
                matchLabels:
                  app: prometheus
    asserts:
      - contains:
          path: spec.ingress[0].from
          content:
            podSelector:
              matchLabels:
                app: prometheus

  - it: should allow ingress from multiple sources
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      networkPolicy:
        enabled: true
        ingress:
          from:
            - namespaceSelector:
                matchLabels:
                  name: monitoring
            - podSelector:
                matchLabels:
                  app: prometheus
    asserts:
      - contains:
          path: spec.ingress[0].from
          content:
            namespaceSelector:
              matchLabels:
                name: monitoring
      - contains:
          path: spec.ingress[0].from
          content:
            podSelector:
              matchLabels:
                app: prometheus
