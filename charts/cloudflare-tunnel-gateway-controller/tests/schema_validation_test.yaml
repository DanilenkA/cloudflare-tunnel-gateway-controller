suite: test schema validation
templates:
  - deployment.yaml
  - secret.yaml
tests:
  # Note: These tests verify that schema validation works correctly.
  # Schema validation happens BEFORE template rendering in Helm,
  # so invalid values will be caught by values.schema.json.

  - it: should accept valid UUID tunnelId
    set:
      cloudflare:
        tunnelId: "550e8400-e29b-41d4-a716-446655440000"
        apiToken: "test-token"
    asserts:
      - template: secret.yaml
        isKind:
          of: Secret

  - it: should accept valid alphanumeric tunnelId with hyphens
    set:
      cloudflare:
        tunnelId: "abc-123-def-456"
        apiToken: "test-token"
    asserts:
      - template: secret.yaml
        isKind:
          of: Secret

  - it: should accept tunnelId with mixed case
    set:
      cloudflare:
        tunnelId: "AbC-123-DeF-456"
        apiToken: "test-token"
    asserts:
      - template: secret.yaml
        isKind:
          of: Secret

  - it: should succeed with apiTokenSecretName instead of apiToken
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiTokenSecretName: "external-secret"
    asserts:
      - template: secret.yaml
        hasDocuments:
          count: 0
      - template: deployment.yaml
        isKind:
          of: Deployment

  - it: should prioritize apiTokenSecretName over apiToken when both provided
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "should-be-ignored"
        apiTokenSecretName: "external-secret"
    asserts:
      - template: secret.yaml
        hasDocuments:
          count: 0
      - template: deployment.yaml
        equal:
          path: spec.template.spec.containers[0].env[0].valueFrom.secretKeyRef.name
          value: "external-secret"

  - it: should work with numeric-only tunnel IDs
    set:
      cloudflare:
        tunnelId: "1234567890"
        apiToken: "test-token"
    asserts:
      - template: secret.yaml
        isKind:
          of: Secret

  - it: should work with single character tunnel ID
    set:
      cloudflare:
        tunnelId: "a"
        apiToken: "test-token"
    asserts:
      - template: secret.yaml
        isKind:
          of: Secret
