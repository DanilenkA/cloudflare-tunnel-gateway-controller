suite: test poddisruptionbudget
templates:
  - poddisruptionbudget.yaml
tests:
  - it: should not create PDB by default
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
    asserts:
      - template: poddisruptionbudget.yaml
        hasDocuments:
          count: 0

  - it: should create PDB when enabled
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      podDisruptionBudget:
        enabled: true
    asserts:
      - template: poddisruptionbudget.yaml
        isKind:
          of: PodDisruptionBudget
      - template: poddisruptionbudget.yaml
        equal:
          path: metadata.name
          value: RELEASE-NAME-cloudflare-tunnel-gateway-controller

  - it: should set minAvailable when specified
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      podDisruptionBudget:
        enabled: true
        minAvailable: 2
    asserts:
      - template: poddisruptionbudget.yaml
        equal:
          path: spec.minAvailable
          value: 2
      - template: poddisruptionbudget.yaml
        notExists:
          path: spec.maxUnavailable

  - it: should set maxUnavailable when specified
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      podDisruptionBudget:
        enabled: true
        minAvailable: null
        maxUnavailable: 1
    asserts:
      - template: poddisruptionbudget.yaml
        equal:
          path: spec.maxUnavailable
          value: 1
      - template: poddisruptionbudget.yaml
        notExists:
          path: spec.minAvailable

  - it: should support percentage values for minAvailable
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      podDisruptionBudget:
        enabled: true
        minAvailable: "50%"
    asserts:
      - template: poddisruptionbudget.yaml
        equal:
          path: spec.minAvailable
          value: "50%"

  - it: should support percentage values for maxUnavailable
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      podDisruptionBudget:
        enabled: true
        minAvailable: null
        maxUnavailable: "25%"
    asserts:
      - template: poddisruptionbudget.yaml
        equal:
          path: spec.maxUnavailable
          value: "25%"

  - it: should set unhealthyPodEvictionPolicy when specified
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      podDisruptionBudget:
        enabled: true
        unhealthyPodEvictionPolicy: "AlwaysAllow"
    asserts:
      - template: poddisruptionbudget.yaml
        equal:
          path: spec.unhealthyPodEvictionPolicy
          value: "AlwaysAllow"

  - it: should not set unhealthyPodEvictionPolicy when null
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      podDisruptionBudget:
        enabled: true
        unhealthyPodEvictionPolicy: null
    asserts:
      - template: poddisruptionbudget.yaml
        notExists:
          path: spec.unhealthyPodEvictionPolicy

  - it: should have correct selector labels
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      podDisruptionBudget:
        enabled: true
    asserts:
      - template: poddisruptionbudget.yaml
        equal:
          path: spec.selector.matchLabels["app.kubernetes.io/name"]
          value: cloudflare-tunnel-gateway-controller
      - template: poddisruptionbudget.yaml
        equal:
          path: spec.selector.matchLabels["app.kubernetes.io/instance"]
          value: RELEASE-NAME

  - it: should have correct labels
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      podDisruptionBudget:
        enabled: true
    asserts:
      - template: poddisruptionbudget.yaml
        equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: cloudflare-tunnel-gateway-controller
      - template: poddisruptionbudget.yaml
        equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: RELEASE-NAME
      - template: poddisruptionbudget.yaml
        exists:
          path: metadata.labels["app.kubernetes.io/version"]

  - it: should work with fullnameOverride
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      fullnameOverride: "my-custom-pdb"
      podDisruptionBudget:
        enabled: true
    asserts:
      - template: poddisruptionbudget.yaml
        equal:
          path: metadata.name
          value: my-custom-pdb

  - it: should work with nameOverride
    set:
      cloudflare:
        tunnelId: "test-tunnel-id"
        apiToken: "test-api-token"
      nameOverride: "cf-ctrl"
      podDisruptionBudget:
        enabled: true
    asserts:
      - template: poddisruptionbudget.yaml
        equal:
          path: metadata.name
          value: RELEASE-NAME-cf-ctrl
